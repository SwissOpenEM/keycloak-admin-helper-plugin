<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>View Source</title>
        <link rel="canonical" href="https://psich.atlassian.net/wiki/pages/viewpage.action?pageId=$action.page.id">
        <script nonce="">
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/wiki\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:curl.cross-origin-resources"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script>
<link type="text/css" rel="stylesheet" nonce="" href="documentation-copy-from-confluence_files/batch_004.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" nonce="" href="documentation-copy-from-confluence_files/batch_003.css" data-wrm-key="plugin.viewsource,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" nonce="" href="documentation-copy-from-confluence_files/batch.css" data-wrm-key="page,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" nonce="" href="documentation-copy-from-confluence_files/batch_005.css" media="print" data-wrm-key="page,-_super" data-wrm-batch-type="context">
<link type="text/css" rel="stylesheet" nonce="" href="documentation-copy-from-confluence_files/batch_002.css" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" nonce="d6bcd7a2fa16452782a24d8e93bf6887" href="//psich.atlassian.net/cdn/psich.atlassian.net/wiki/s/e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855-CDN/416663319/h/373caabbb7871fb327dd44666b0ed8d9561563459b6d293b59563f8c2eb3e2e4/_/download/contextbatch/css/editor-content,-_super/batch.css?assetVersion=1000.0.0-311cc714c66419827&amp;conditionalComment=lte+IE+9&amp;confluence.table.resizable=true&amp;externals=__local-default__&amp;relative-url=true" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" nonce="" href="documentation-copy-from-confluence_files/com.atlassian.confluence.plugins.confluence-mentions-plugin_.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-mentions-plugin:mentions-styling" data-wrm-batch-type="resource" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <h2>Intro about the plugin:</h2><p>The 
plugin is not planned as a replacement of the permissions solution. That
 was only a very early stage when I thought that it is simple to also 
modify the UI using a plugin. As this is not easy / almost impossible, 
the plugin is now more thought as a helper, to support administrative 
tasks. Currently, there is no explicit development plan, it is more a 
research project.</p><p>A plugin is packed as a jar file and can simply be installed using the following Dockerfile:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="9eb6ca54-85cb-4d2b-ae30-424fbbf370b0" data-macro-schema-version="1" style="background-image: url(https://psich.atlassian.net/wiki/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGV9&amp;locale=en_US&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tbody><tr><td class="wysiwyg-macro-body"><pre>FROM quay.io/keycloak/keycloak:26.2.0
USER root
COPY plugins/*.jar /opt/keycloak/providers/
USER 1000
RUN /opt/keycloak/bin/kc.sh build   # this binds the plugin to keycloak
RUN /opt/keycloak/bin/kc.sh show-config | grep keycloak-facilities-admin-plugin</pre></td></tr></tbody></table><p>Roughly, a plugin can do the following (for the project relevant) steps:</p><ul><li><p>Listen
 to admin events, do any action whenever a group/user is 
created/modified/deleted. Almost every KeyCloak object can be used as a 
trigger.</p></li><li><p>Change the parent of a group, make it top-level.
 This could be used as a workaround to the UI create group button which 
is not available if the user has only partial create group permissions 
using a policy</p></li><li><p>Assign policies and permission to groups</p></li><li><p>Rename a group, set attributes, change any other properties</p></li><li><p>Similar changes on users</p></li><li><p>It
 is possible to do some automatic bootstrap configuration, eg initially 
setting permissions and policies on a setup where they didn’t exist 
already</p></li><li><p>It is possible to use configuration parameters 
for the plugin, at least I found structures for it. right know, I don’t 
know how to set them in the UI. possible configuration values: 
permissions and policies could be set as a template in json format with 
placeholders so that simple changes can be done without code changes.</p></li></ul><p>From
 my experience, it was difficult to change existing 
policies/permissions, I didn’t manage to find useful API calls, and have
 an open question on <a href="https://stackoverflow.com/questions/79598549/keycloak-plugin-add-group-to-existing-permission">StackOverflow</a>.</p><p>Maintainability:</p><ul><li><p>The API is not stable over versions. And the <a href="https://github.com/keycloak/keycloak/discussions/37133">Fine Grained Admin Permissions</a>
 Feature is still new and buggy. I expect some changes in the near 
future, and it’s very likely that the plugin has to be updated from time
 to time.</p></li></ul><h2><span class="inline-comment-marker" data-ref="b824cb2a-a975-49cb-9977-0cee747ab10c">Intro about the permissions/policy solution:</span></h2><p>mainy <a class="confluence-link confluence-userlink user-mention" data-account-id="60c35284deecef006a0f19de" href="https://psich.atlassian.net/wiki/people/60c35284deecef006a0f19de?ref=confluence" target="_blank" data-linked-resource-id="36995391" data-linked-resource-version="1" data-linked-resource-type="userinfo" userkey="60c35284deecef006a0f19de" data-linked-resource-default-alias="Minotti Carlo" data-base-url="https://psich.atlassian.net/wiki">Minotti Carlo</a>  worked on this proposal. There is an early variant with only allow rules, and later variants with allow and deny rules.</p><p>In short, none of these solutions was able to cover all use cases, in particular:</p><ul><li><p>if
 a user is mapped to groups of different facilities at the same time, it
 disappears completely from the user lists, because there’s always a 
deny rule that applies to it</p></li><li><p>there are some weird 
behaviours when one permission uses multiple policies. we had a 
situation where all groups and users disappeared immediately</p></li><li><p>if
 a user is only assigned to a subgroup but not to the top-level group, 
there are some issues in the KeyCloak UI. I assume that it sometimes 
tries to get the parent of a group, but doesn’t have permission. This 
probably results in an internal error, messes up the caches, and results
 in unexpected UI errors, even locations where there’s no direct 
relevance to users and groups.</p></li></ul><p>Maintainability:</p><ul><li><p>As the <a href="https://github.com/keycloak/keycloak/discussions/37133">Fine Grained Admin Permissions</a>
 Feature is still quite new and buggy, it is likely that event the best 
(static) configuration will not work anymore from one version to 
another. Therefore, there should be a list of manual tests which are 
executed after every update just to make sure the behaviour didn’t 
change.</p></li></ul><h2>The current POC implementation</h2><p>See it as
 a proposal, and feature demonstration. The final plugin could look 
differently. Important for the POC was finding ways to listen on events,
 and to change users, groups and add policies and permissions. The 
current implementation has the following workflow:</p><ol start="1"><li><p>Listen on admin events of type Operation==<code>CREATE</code>, ResourceType==<code>GROUP</code></p></li><li><p>Some sanity checks (event information, group must be sub group, parent must have facility attribute set, ..)</p></li><li><p>Finding a new name for the group which doesn’t collide with an already-existing object</p></li><li><p>Rename group to the new name</p></li><li><p>Make the sub-group a top-level group</p></li><li><p>Create or get existing positive policy of type user for <code>facilityName + "-admin"</code> . It is also possible to add all <code>facilityName + "-"</code>
 -prefixed users, but this would also open a new security leak. But it 
is always possible to modify the created policy manually and add other 
users.</p></li><li><p>Create permission for the group with the given policy and scope <code>["view-members", "manage-membership", "manage-members", "view", "manage"]</code>.
 At this point, changing existing permissions seems not possible (yet) 
as the API seems incomplete here. But creating new permissions is 
possible. The only difference: The list of permissions will grow faster 
and will have and entry for each group.</p></li></ol><p>The plugin does 
NOT use deny permissions. This is simply not necessary. Advantage of 
this: there is less complexity in the permissions structure and a lower 
risk for mis-configuration and safety holes. The “more” of 
administration effort is covered by the automatism of the plugin.</p><h3>dry demo</h3><ol start="1"><li><p>Create a new realm </p><img class="confluence-embedded-image image-center" alt="image-20250507-100313.png" width="760" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-100313.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-100313.png?version=1&amp;modificationDate=1746612195590&amp;cacheVersion=1&amp;api=v2" data-height="719" data-width="1022" data-unresolved-comment-count="0" data-linked-resource-id="336822308" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-100313.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="760db685-6930-4263-9c1c-becbb9a8f9f2" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-100313.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-100313.png" data-image-height="719" data-image-width="1022"></li><li><p>Enable Admin Permissions </p><img class="confluence-embedded-image image-center" alt="image-20250507-132229.png" width="736" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-132229.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-132229.png?version=1&amp;modificationDate=1746624150643&amp;cacheVersion=1&amp;api=v2" data-height="353" data-width="882" data-unresolved-comment-count="0" data-linked-resource-id="337313797" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-132229.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="c380f7e4-2fd7-422f-9b01-28c7b5c56ddb" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-132229.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-132229.png" data-image-height="353" data-image-width="882"></li><li><p>The
 plugin is not yet active for this realm. It has to be activated 
manually by adding the event listener. This also means: the plugin is 
activatable per realm and not globally active:</p><img class="confluence-embedded-image image-center" alt="image-20250507-105010.png" width="760" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-105010.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-105010.png?version=1&amp;modificationDate=1746615012277&amp;cacheVersion=1&amp;api=v2" data-height="915" data-width="1610" data-unresolved-comment-count="0" data-linked-resource-id="336822316" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-105010.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="27030588-1bff-4a95-b148-4625dadad7cd" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-105010.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-105010.png" data-image-height="915" data-image-width="1610"></li><li><p>Create first facility, by simple creating a new group with name <code>psi--initnewfacility</code> (the suffice must be exact, the prefix is the facility name. note the two hyphens)</p><img class="confluence-embedded-image image-center" alt="image-20250507-132746.png" width="579" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-132746.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-132746.png?version=1&amp;modificationDate=1746624467323&amp;cacheVersion=1&amp;api=v2" data-height="215" data-width="579" data-unresolved-comment-count="0" data-linked-resource-id="337346566" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-132746.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="51befafa-1413-4340-be48-8e0f7ae68284" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-132746.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-132746.png" data-image-height="215" data-image-width="579"></li><li><p>As
 you noticed, there is no such group in the group list, but a new group.
 psi-template. At this point, the plugin came in action. </p><img class="confluence-embedded-image image-center" alt="image-20250507-133520.png" width="736" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-133520.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-133520.png?version=1&amp;modificationDate=1746624921854&amp;cacheVersion=1&amp;api=v2" data-height="345" data-width="1362" data-unresolved-comment-count="0" data-linked-resource-id="336691266" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-133520.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="046a44c7-3846-4a3d-8eb2-1e8178cf9a47" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-133520.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-133520.png" data-image-height="345" data-image-width="1362"><p>It did:</p><ol start="1"><li><p>see, there is a new top-level group with the <code>"--initnewfacility"</code> token</p></li><li><p>extract the facility Name psi from it</p></li><li><p>create a new group <code>psi-template</code> with attribute <code>"facility-name" = "psi"</code></p></li><li><p>create a new user <code>psi-admin</code>.
 This is not a security leak because the user has no credentials, and 
the initial group must be toplevel which only the superadmin is allowed 
to do</p></li><li><p>Assign policy and permission to the new group</p></li><li><p>Remove the group psi-template. It was only used as a trigger</p></li></ol></li><li><p>Manually add <code>view-users</code> role to newly created user. This should also be done by the plugin, but so far it doesn’t work.</p></li><li><p>For fun, create more facilities by creating a group <code>epfl--initnewfacility</code> and <code>eth--initnewfacility</code></p></li><li><p>That’s
 it. You can now set credentials for the new admin users and login as a 
facility manager. The url can be seen at the Clients tab: </p><img class="confluence-embedded-image image-center" alt="image-20250507-134306.png" width="736" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-134306.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-134306.png?version=1&amp;modificationDate=1746625387308&amp;cacheVersion=1&amp;api=v2" data-height="607" data-width="1879" data-unresolved-comment-count="0" data-linked-resource-id="336789591" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-134306.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="f9d7c9b3-f70c-4dbe-886d-98124e356302" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-134306.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-134306.png" data-image-height="607" data-image-width="1879"></li></ol><p>The following is done with a facility admin login</p><ol start="1"><li><p>Login as a facility admin </p><img class="confluence-embedded-image image-center" alt="image-20250507-134529.png" width="579" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-134529.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-134529.png?version=1&amp;modificationDate=1746625531055&amp;cacheVersion=1&amp;api=v2" data-height="468" data-width="579" data-unresolved-comment-count="0" data-linked-resource-id="336691274" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-134529.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="287e15a2-9f7b-41ac-81ef-436a6197d148" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-134529.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-134529.png" data-image-height="468" data-image-width="579"><p></p></li><li><p>You can see all users, add some, but not edit </p><img class="confluence-embedded-image image-center" alt="image-20250507-141926.png" width="736" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-141926.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-141926.png?version=1&amp;modificationDate=1746627567729&amp;cacheVersion=1&amp;api=v2" data-height="583" data-width="1285" data-unresolved-comment-count="0" data-linked-resource-id="337575938" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-141926.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="b9b657b8-e29b-428e-a8b3-97be1d9b3c3c" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-141926.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-141926.png" data-image-height="583" data-image-width="1285"></li><li><p>You can see all groups, but not add new top-level groups: </p><img class="confluence-embedded-image image-center" alt="image-20250507-142004.png" width="736" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-142004.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-142004.png?version=1&amp;modificationDate=1746627605336&amp;cacheVersion=1&amp;api=v2" data-height="583" data-width="1285" data-unresolved-comment-count="0" data-linked-resource-id="337477644" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-142004.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="8838a8f1-d935-4708-9932-504182e6176d" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-142004.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-142004.png" data-image-height="583" data-image-width="1285"></li><li><p>But you can add a new sublevel group in any group of your facility, here psi: </p><img class="confluence-embedded-image image-center" alt="image-20250507-142115.png" width="736" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-142115.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-142115.png?version=1&amp;modificationDate=1746627676852&amp;cacheVersion=1&amp;api=v2" data-height="581" data-width="1226" data-unresolved-comment-count="0" data-linked-resource-id="337412103" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-142115.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="4fb68a3d-f088-44a2-aab0-3490d5ad7f3a" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-142115.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-142115.png" data-image-height="581" data-image-width="1226"></li><li><p>it
 doesn’t matter if you added a prefix. if it is not prefixed by the 
facility name, the facility name will automatically be prefixed. and the
 group also automatically becomes a top-level group (this is not a 
requirement and can be disabled if you wish). The new group also 
automatically gets policy and permission and has the same 
characteristics as psi-template:  </p><img class="confluence-embedded-image image-center" alt="image-20250507-142303.png" width="438" loading="lazy" src="documentation-copy-from-confluence_files/image-20250507-142303.png" data-image-src="https://psich.atlassian.net/wiki/download/attachments/335937537/image-20250507-142303.png?version=1&amp;modificationDate=1746627785087&amp;cacheVersion=1&amp;api=v2" data-height="239" data-width="438" data-unresolved-comment-count="0" data-linked-resource-id="337444871" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20250507-142303.png" data-base-url="https://psich.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="335937537" data-linked-resource-container-version="3" data-media-id="57128ba3-2f6b-4c4d-9ebf-d3294d234856" data-media-type="file" title="OpenEM &gt; Plugin POC &gt; image-20250507-142303.png" data-location="OpenEM &gt; Plugin POC &gt; image-20250507-142303.png" data-image-height="239" data-image-width="438"></li><li><p>Right now, the user is not allowed to create a new user. Use the superadmin login to create some.</p></li><li><p>Also,
 right now, it is not possible to add users to the group. Sorry for 
that. But that’s only about fine-tuning admin-permissions</p></li></ol><p>
        </p><p>&nbsp;</p>
    

</body></html>